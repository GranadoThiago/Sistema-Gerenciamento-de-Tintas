<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>Gerenciamento de Tintas</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        form { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; }
        button:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; }
        .btn-danger { background: #f44336; }
        .btn-warning { background: #ff9800; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f2f2f2; }
        .section { margin-bottom: 20px; }
        h2 { color: #333; }
        #pesquisa { border: 2px solid #ddd; border-radius: 4px; font-size: 16px; width: 70%; padding: 10px; }
        #pesquisa:focus { border-color: #4CAF50; outline: none; }
    </style>
</head>
<body>
    <h1>üñåÔ∏è Sistema de Manipula√ß√£o de Tintas</h1>
    
    <form id="manipulacaoForm">
        <h2>Dados do Cliente</h2>
        <input type="text" id="cliente" placeholder="Nome do Cliente" required>
        <input type="text" id="produtoCliente" placeholder="Produto" required>
        <input type="text" id="endereco" placeholder="Endere√ßo" required>
        <input type="date" id="dataManipulacao" required>
        
        <h2>Detalhes da Manipula√ß√£o</h2>
        <input type="text" id="grupo" placeholder="Grupo">
        <input type="text" id="nomeCor" placeholder="Nome da Cor (C√≥digo)">
        <input type="text" id="produtoManip" placeholder="Produto">
        <input type="text" id="embalagem" placeholder="Embalagem">
        <input type="text" id="baseUsada" placeholder="Base Usada">
        <input type="number" id="quantidade" placeholder="Quantidade" step="1" required>
        
        <h2>Observa√ß√µes</h2>
        <textarea id="observacao" placeholder="Observa√ß√µes"></textarea>
        
        <div>
            <button type="submit">üíæ Salvar</button>
            <button type="button" class="btn-secondary" onclick="editarManipulacao(null)">üÜï Novo</button>
        </div>
    </form>

    <div class="section">
        <input type="text" id="pesquisa" placeholder="üîç Pesquisar Cliente, Cor, Data ou Grupo..." onkeyup="pesquisarDados()">
        <button class="btn-warning" onclick="limparPesquisa()">Limpar</button>
    </div>

    <div class="section">
        <button onclick="exportarCSVFormatado()">üìä CSV</button>
        <button onclick="exportarExcel()">üìà Excel</button>
        <button onclick="exportarPDF()">üìÑ PDF</button>
        <button class="btn-secondary" onclick="verificarDados()">‚ÑπÔ∏è Total Registros</button>
    </div>

    <table id="tabelaManipulacoes">
        <thead>
            <tr>
                <th>Cliente</th><th>Data</th><th>Cor</th><th>Qtd</th><th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let db, todosOsDados = [];
        const DB_NAME = 'TintasDB', DB_VERSION = 1;
        let editId = null;

        // Inicializar IndexedDB
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => console.error('Erro ao abrir DB');
        request.onsuccess = (event) => { db = event.target.result; carregarTabela(); };
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            const store = db.createObjectStore('manipulacoes', { keyPath: 'id', autoIncrement: true });
            store.createIndex('cliente', 'cliente', { unique: false });
            store.createIndex('nomeCor', 'nomeCor', { unique: false });
        };

        // CRUD
        document.getElementById('manipulacaoForm').onsubmit = (e) => {
            e.preventDefault();
            const manipulacao = {
                cliente: document.getElementById('cliente').value,
                produtoCliente: document.getElementById('produtoCliente').value,
                endereco: document.getElementById('endereco').value,
                dataManipulacao: document.getElementById('dataManipulacao').value,
                grupo: document.getElementById('grupo').value,
                nomeCor: document.getElementById('nomeCor').value,
                produtoManip: document.getElementById('produtoManip').value,
                embalagem: document.getElementById('embalagem').value,
                baseUsada: document.getElementById('baseUsada').value,
                quantidade: parseFloat(document.getElementById('quantidade').value),
                observacao: document.getElementById('observacao').value,
                dataCadastro: new Date().toISOString()
            };

            const transaction = db.transaction(['manipulacoes'], 'readwrite');
            const store = transaction.objectStore('manipulacoes');
            if (editId) { manipulacao.id = editId; store.put(manipulacao); } 
            else { store.add(manipulacao); }

            transaction.oncomplete = () => { limparForm(); carregarTabela(); editId = null; };
        };

        function limparForm() { document.getElementById('manipulacaoForm').reset(); }

        function editarManipulacao(id) {
            if (!id) { limparForm(); editId = null; return; }
            const transaction = db.transaction(['manipulacoes'], 'readonly');
            const store = transaction.objectStore('manipulacoes');
            const request = store.get(id);
            request.onsuccess = () => {
                const data = request.result;
                if (data) {
                    Object.keys(data).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = data[key] || '';
                    });
                    editId = id;
                }
            };
        }

        function excluirManipulacao(id) {
            if (confirm('Confirmar exclus√£o?')) {
                const transaction = db.transaction(['manipulacoes'], 'readwrite');
                transaction.objectStore('manipulacoes').delete(id);
                transaction.oncomplete = carregarTabela;
            }
        }

        // Tabela e Pesquisa
        function carregarTabela(filtro = '') {
            const tbody = document.querySelector('#tabelaManipulacoes tbody');
            tbody.innerHTML = '';
            const transaction = db.transaction(['manipulacoes'], 'readonly');
            const store = transaction.objectStore('manipulacoes');
            const request = store.getAll();
            
            request.onsuccess = () => {
                todosOsDados = request.result;
                let dadosFiltrados = todosOsDados;
                if (filtro) {
                    dadosFiltrados = todosOsDados.filter(manip => 
                        manipulacaoFiltrada(manip, filtro.toLowerCase())
                    );
                }
                dadosFiltrados.forEach(manip => criarLinhaTabela(manip));
            };
        }

        function manipulacaoFiltrada(manip, termo) {
            return manip.cliente?.toLowerCase().includes(termo) ||  // ‚úÖ CORRIGIDO: manip ao inv√©s de manipulacao
            manip.nomeCor?.toLowerCase().includes(termo) ||         // ‚úÖ CORRIGIDO
            manip.dataManipulacao?.includes(termo) ||               // ‚úÖ CORRIGIDO
            manip.grupo?.toLowerCase().includes(termo) ||           // ‚úÖ CORRIGIDO
            manip.produtoCliente?.toLowerCase().includes(termo);    // ‚úÖ CORRIGIDO
}


        function pesquisarDados() {
            const termo = document.getElementById('pesquisa').value;
            carregarTabela(termo);
        }

        function limparPesquisa() {
            document.getElementById('pesquisa').value = '';
            carregarTabela();
        }

        function criarLinhaTabela(manip) {
            const tbody = document.querySelector('#tabelaManipulacoes tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${manip.cliente}</td>
                <td>${formatarDataBR(manip.dataManipulacao)}</td>
                <td>${manip.nomeCor || '-'}</td>
                <td>${manip.quantidade}</td>
                <td>
                    <button class="btn-secondary" onclick="mostrarDetalhes(${manip.id})">Detalhes</button>
                    <button class="btn-secondary" onclick="editarManipulacao(${manip.id})">Editar</button>
                    <button class="btn-danger" onclick="excluirManipulacao(${manip.id})">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        }

        function mostrarDetalhes(id) {
            const transaction = db.transaction(['manipulacoes'], 'readonly');
            const store = transaction.objectStore('manipulacoes');
            const request = store.get(id);

            request.onsuccess = () => {
                const d = request.result;
                if (!d) return;

                const texto =
                    `Cliente: ${d.cliente}\n` +
                    `Produto (cliente): ${d.produtoCliente}\n` +
                    `Endere√ßo: ${d.endereco}\n` +
                    `Data: ${d.dataManipulacao}\n\n` +
                    `Grupo: ${d.grupo}\n` +
                    `Nome da cor: ${d.nomeCor}\n` +
                    `Produto (manipula√ß√£o): ${d.produtoManip}\n` +
                    `Embalagem: ${d.embalagem}\n` +
                    `Base usada: ${d.baseUsada}\n` +
                    `Quantidade: ${d.quantidade}\n\n` +
                    `Observa√ß√£o:\n${d.observacao || ''}`;

                alert(texto);
            };
        }


        // Exporta√ß√µes
        function exportarCSVFormatado() {
            const transaction = db.transaction(['manipulacoes'], 'readonly');
            const store = transaction.objectStore('manipulacoes');
            const request = store.getAll();
            request.onsuccess = () => {
                const dados = request.result.map(r => ({
                    Cliente: r.cliente, Produto: r.produtoCliente, Endere√ßo: r.endereco,
                    Data: r.dataManipulacao, Grupo: r.grupo || '', 'Nome da Cor': r.nomeCor,
                    Embalagem: r.embalagem || '', 'Base Usada': r.baseUsada || '',
                    Quantidade: r.quantidade, Observa√ß√£o: r.observacao || ''
                }));
                const csv = [
                    ['RELAT√ìRIO DE MANIPULA√á√ïES DE TINTAS', '', `Gerado: ${new Date().toLocaleDateString('pt-BR')}`],
                    ['', '', `Total: ${dados.length} registros`],
                    Object.keys(dados[0] || {}),
                    ...dados.map(d => Object.values(d))
                ].map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `manipulacoes-tintas_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };
        }

        function exportarExcel() {
            const transaction = db.transaction(['manipulacoes'], 'readonly');
            const store = transaction.objectStore('manipulacoes');
            const request = store.getAll();
            request.onsuccess = () => {
                const dados = request.result.map(r => ({
                    Cliente: r.cliente, Produto: r.produtoCliente, Endere√ßo: r.endereco,
                    Data: r.dataManipulacao, Grupo: r.grupo || '', 'Nome da Cor': r.nomeCor,
                    Embalagem: r.embalagem || '', 'Base Usada': r.baseUsada || '',
                    Quantidade: r.quantidade, Observa√ß√£o: r.observacao || ''
                }));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(dados);
                ws['!cols'] = [{wch:20},{wch:15},{wch:25},{wch:12},{wch:12},{wch:18},{wch:12},{wch:12},{wch:10},{wch:30}];
                XLSX.utils.book_append_sheet(wb, ws, 'Manipula√ß√µes');
                XLSX.writeFile(wb, `manipulacoes-tintas_${new Date().toISOString().split('T')[0]}.xlsx`);
            };
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text('Relat√≥rio de Manipula√ß√µes de Tintas', 20, 20);
            doc.setFontSize(12);
            doc.text(`Gerado: ${new Date().toLocaleDateString('pt-BR')}`, 20, 35);
            
            const transaction = db.transaction(['manipulacoes'], 'readonly');
            const store = transaction.objectStore('manipulacoes');
            const request = store.getAll();
            request.onsuccess = () => {
                const registros = request.result;
                let y = 50;
                doc.setFontSize(10);
                doc.text('Cliente | Data | Cor | Qtd | Endere√ßo | Observa√ß√£o', 20, y);
                y += 10;
                
                registros.forEach((manip) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    const linha = `${manip.cliente?.substring(0,15) || ''} | ${manip.dataManipulacao} | ${manip.nomeCor || ''} | ${manip.quantidade} | ${manip.endereco?.substring(0,20) || ''} | ${manip.observacao?.substring(0,25) || ''}`;
                    doc.text(linha, 20, y);
                    y += 7;
                });
                doc.save('manipulacoes-tintas.pdf');
            };
        }

        function verificarDados() {
            const transaction = db.transaction(['manipulacoes'], 'readonly');
            transaction.objectStore('manipulacoes').count().onsuccess = (e) => 
                alert(`üìä Total de registros: ${e.target.result}`);
        }

        // Fun√ß√£o auxiliar para formatar data
        function formatarDataBR(iso) {
            if (!iso) return '';
            const [ano, mes, dia] = iso.split('-'); // "2025-12-09"
            return `${dia}/${mes}/${ano}`;          // "09/12/2025"
        }

    </script>
</body>
</html>